<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン原稿用紙</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1a73e8; /* Google Blue */
            --bg-color: #f8f9fa;
            --paper-color: #fdfbf7;
            --line-color: rgba(46, 125, 50, 0.4); /* 深緑 */
            --line-strong: rgba(46, 125, 50, 0.8);
        }

        body {
            font-family: "Zen Maru Gothic", sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        /* --- ヘッダー --- */
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .navbar-brand {
            font-weight: 700;
            color: #444;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- ルビの調整 --- */
        ruby {
            ruby-position: over;
        }
        rt {
            font-size: 0.6em;
            color: #666;
            font-weight: normal;
        }

        /* --- レイアウト --- */
        .main-container {
            height: calc(100vh - 60px - 30px); /* Header - Footer */
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- 入力エリア（ノート風） --- */
        .input-area-wrapper {
            flex-grow: 1;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        #content {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            padding: 20px;
            font-family: "Zen Maru Gothic", sans-serif;
            font-size: 1.1rem;
            line-height: 2rem;
            background-image: linear-gradient(#f1f5f9 1px, transparent 1px);
            background-size: 100% 2rem;
            outline: none;
        }
        .char-counter {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- 原稿用紙プレビュー --- */
        .preview-area {
            background-color: #e9ecef;
            border-radius: 12px;
            /* 横スクロール有効化、縦は隠す */
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            align-items: center; /* 上下中央 */
            justify-content: flex-start; /* コンテンツの配置 */
            padding: 20px;
            position: relative;
            /* 縦書きに合わせて右から左へスクロール */
            direction: rtl; 
        }
        
        /* スケール調整後のサイズを確保するラッパー */
        #paper-wrapper {
            /* JSでサイズ設定 */
            flex-shrink: 0;
            position: relative;
            margin: 0 auto; /* 必要に応じて */
        }

        /* スケーリング対象 */
        #paper-scaler {
            transform-origin: top right; /* 右上基準で縮小 */
            transition: transform 0.3s ease-out;
            position: absolute;
            top: 0;
            right: 0;
        }

        .paper-sheet {
            background-color: var(--paper-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 40px;
            
            /* 中身に合わせてサイズ決定 */
            width: fit-content;
            height: fit-content;
            min-height: 80vh; 
            min-width: 600px;
            
            display: flex;
            justify-content: flex-start;
            direction: ltr; /* 内部は左書き扱い(flex-directionで制御) */
            box-sizing: border-box;
        }

        .genko-grid-wrapper {
            display: flex;
            flex-direction: row-reverse; /* 右から左へ行を追加 */
            gap: 0;
            height: 100%;
        }

        .genko-line {
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--line-color);
            flex-shrink: 0;
        }
        .genko-line:first-child { border-right: 1px solid var(--line-strong); }
        .genko-line { border-left: 1px solid var(--line-strong); }

        .genko-cell {
            font-family: "Zen Old Mincho", serif;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--line-color);
            color: #2c3e50;
            position: relative;
            flex-shrink: 0;
        }
        .genko-cell:first-child { border-top: 1px solid var(--line-strong); }
        .genko-cell:last-child { border-bottom: 1px solid var(--line-strong); }

        /* 画面表示用ぶら下がりスタイル */
        .hanging-char {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            writing-mode: vertical-rl;
            font-size: 0.7em;
            line-height: 1;
            margin-top: 0.1em;
            pointer-events: none;
            color: #000;
        }

        /* --- ローディングオーバーレイ --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        /* --- 印刷用スタイル --- */
        @media print {
            body * { visibility: hidden; }
            #print-render-area, #print-render-area * { visibility: visible; }
            #print-render-area {
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0;
            }
            @page { size: A4 landscape; margin: 0; }
            
            .print-page {
                width: 297mm; height: 210mm;
                page-break-after: always;
                position: relative;
                font-family: "Zen Old Mincho", serif;
                background: white;
                box-sizing: border-box;
                padding: 10mm;
            }
            
            .print-layout-grid {
                width: 100%;
                height: 100%;
                display: grid;
                grid-template-columns: 1fr 16mm 1fr;
                border: 2px solid #2e7d32;
            }

            .print-gyobi-area {
                border-left: 1px solid #2e7d32;
                border-right: 1px solid #2e7d32;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: #2e7d32;
            }
            .gyobi-content {
                writing-mode: vertical-rl;
                display: flex;
                align-items: center;
                gap: 10mm;
            }
            .gyobi-mark {
                border: 1px solid #2e7d32;
                width: 6mm; height: 10mm;
                border-radius: 50% 50% 0 0;
                margin-bottom: 5mm;
            }

            .print-half-grid {
                display: flex;
                flex-direction: row-reverse;
            }

            .print-line {
                flex: 1; display: flex; flex-direction: column;
                border-left: 1px solid rgba(46,125,50,0.4);
            }
            .print-half-grid.right-side .print-line:first-child { border-right: none; }
            .print-half-grid.left-side .print-line:first-child { border-right: none; }

            .print-cell {
                flex: 1; border-bottom: 1px solid rgba(46,125,50,0.4);
                display: flex; align-items: center; justify-content: center;
                position: relative;
                writing-mode: vertical-rl;
                text-orientation: mixed;
            }
            
            .hanging-chars-print {
                position: absolute; 
                top: 100%; 
                left: 50%; 
                transform: translateX(-50%);
                white-space: nowrap; 
                writing-mode: vertical-rl; 
                font-size: 0.6em;
                margin-top: -2mm;
                line-height: 1;
            }
        }
    </style>
</head>
<body>

    <!-- ヘッダー (App Bar) -->
    <nav class="navbar sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="bi bi-pencil-square text-primary fs-3"></i>
                <div>
                    <span class="d-block lh-1">オンライン<ruby>原稿<rt>げんこう</rt></ruby><ruby>用紙<rt>ようし</rt></ruby></span>
                </div>
            </a>
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-secondary btn-sm rounded-circle p-2" onclick="showSettings()">
                    <i class="bi bi-gear-fill"></i>
                </button>
                <span class="badge bg-light text-secondary border">v1.0</span>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid main-container">
        <div class="row h-100 g-3">
            
            <!-- 左カラム：入力・操作 -->
            <div class="col-lg-4 col-md-5 h-100">
                <div class="card p-3">
                    <div class="mb-3">
                        <label class="form-label small text-muted mb-1"><ruby>基本<rt>きほん</rt></ruby><ruby>情報<rt>じょうほう</rt></ruby></label>
                        <input type="text" id="title" class="form-control mb-2" placeholder="題名（だいめい）">
                        <div class="row g-2">
                            <div class="col-4">
                                <input type="text" id="class" class="form-control" placeholder="学年（がくねん）">
                            </div>
                            <div class="col-8">
                                <input type="text" id="name" class="form-control" placeholder="氏名（しめい）">
                            </div>
                        </div>
                    </div>

                    <div class="input-area-wrapper mb-3">
                        <textarea id="content" placeholder="ここをクリックして、作文（さくぶん）をかきましょう..."></textarea>
                        <div class="char-counter">
                            <span id="char-count-val">0</span> <ruby>文字<rt>もじ</rt></ruby>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-secondary w-100" id="btn-new">
                                    <i class="bi bi-file-earmark-plus"></i> <ruby>新規<rt>しんき</rt></ruby><ruby>作成<rt>さくせい</rt></ruby>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" id="btn-load">
                                    <i class="bi bi-folder2-open"></i> <ruby>読<rt>よ</rt></ruby>み<ruby>込<rt>こ</rt></ruby>み
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" id="btn-save">
                            <i class="bi bi-cloud-arrow-up-fill me-2"></i> <ruby>保存<rt>ほぞん</rt></ruby>する
                        </button>
                        <button class="btn btn-success w-100" id="btn-print">
                            <i class="bi bi-printer-fill me-2"></i> <ruby>印刷<rt>いんさつ</rt></ruby>する
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右カラム：プレビュー -->
            <div class="col-lg-8 col-md-7 h-100">
                <div class="card preview-area" id="paper-container">
                    <!-- 自動フィット用のラッパー構造 -->
                    <div id="paper-wrapper">
                        <div id="paper-scaler">
                            <div class="paper-sheet" id="paper-sheet">
                                <div id="genko-grid" class="genko-grid-wrapper">
                                    <!-- JSで生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <footer class="fixed-bottom bg-white border-top py-2 text-center text-muted small">
        &copy; 2026 オンライン原稿用紙 <a href="https://note.com/cute_borage86" target="_blank" rel="noopener noreferrer" class="text-reset text-decoration-none">GIGA山</a>
    </footer>

    <!-- 印刷用レンダリングエリア（非表示） -->
    <div id="print-render-area"></div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <div class="mt-3 fw-bold text-primary fs-5"><ruby>処理<rt>しょり</rt></ruby><ruby>中<rt>ちゅう</rt></ruby>です...</div>
    </div>

    <!-- 外部ライブラリJS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- State ---
        const state = {
            currentDraftId: null,
            charsPerLine: 20, // 20 or 15
            allDrafts: []
        };

        const STORAGE_KEY = 'genko_draft_v1';

        // --- Elements ---
        const ui = {
            title: document.getElementById('title'),
            class: document.getElementById('class'),
            name: document.getElementById('name'),
            content: document.getElementById('content'),
            charCount: document.getElementById('char-count-val'),
            grid: document.getElementById('genko-grid'),
            printArea: document.getElementById('print-render-area'),
            loading: document.getElementById('loading-overlay'),
            // 自動フィット用要素
            paperContainer: document.getElementById('paper-container'),
            paperWrapper: document.getElementById('paper-wrapper'),
            paperScaler: document.getElementById('paper-scaler'),
            paperSheet: document.getElementById('paper-sheet'),
            
            btns: {
                new: document.getElementById('btn-new'),
                save: document.getElementById('btn-save'),
                load: document.getElementById('btn-load'),
                print: document.getElementById('btn-print')
            }
        };

        const setLoading = (isLoading) => {
            ui.loading.style.display = isLoading ? 'flex' : 'none';
        };

        // --- Logic: Auto Save ---
        
        const autoSave = () => {
            const data = {
                id: state.currentDraftId,
                title: ui.title.value,
                class: ui.class.value,
                name: ui.name.value,
                content: ui.content.value,
                charsPerLine: state.charsPerLine,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        };

        const tryRestore = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.title || data.content || data.name || data.class) {
                        ui.title.value = data.title || '';
                        ui.class.value = data.class || '';
                        ui.name.value = data.name || '';
                        ui.content.value = data.content || '';
                        state.currentDraftId = data.id || null;
                        if (data.charsPerLine) state.charsPerLine = data.charsPerLine;
                        
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                        });
                        Toast.fire({ 
                            icon: 'info', 
                            html: '<span class="fw-bold"><ruby>編集<rt>へんしゅう</rt></ruby><ruby>中<rt>ちゅう</rt></ruby>のデータを<ruby>復元<rt>ふくげん</rt></ruby>しました</span>' 
                        });
                        
                        renderApp();
                    }
                } catch (e) {
                    console.error('復元エラー:', e);
                }
            }
        };

        const clearAutoSave = () => {
            localStorage.removeItem(STORAGE_KEY);
        };

        // --- Logic: Rendering & Scaling ---
        
        // 【修正】高さを基準にフィットさせ、横はスクロール可能にする
        const fitPaperToScreen = () => {
            ui.paperScaler.style.transform = 'scale(1)';
            ui.paperWrapper.style.width = 'auto';
            ui.paperWrapper.style.height = 'auto';
            
            const containerHeight = ui.paperContainer.clientHeight - 40; // padding分
            const paperWidth = ui.paperSheet.scrollWidth;
            const paperHeight = ui.paperSheet.scrollHeight;

            if (paperHeight === 0) return;

            // 高さのみの比率を計算
            let scale = containerHeight / paperHeight;
            if (scale > 1) scale = 1; // 拡大はしない

            // 変形適用
            ui.paperScaler.style.transform = `scale(${scale})`;
            
            // スケーリング後の実サイズをラッパーに設定して、スクロール領域を確保
            ui.paperWrapper.style.width = `${paperWidth * scale}px`;
            ui.paperWrapper.style.height = `${paperHeight * scale}px`;
        };

        const generateHeaderLines = (title, className, name, chars) => {
            const lines = [];
            const titleParas = title.split('\n');
            titleParas.forEach(p => {
                if(!p && lines.length === 0) return;
                let line = Array(chars).fill('');
                let cursor = 2; 
                p.split('').forEach(c => {
                    if(cursor >= chars) { lines.push(line); line = Array(chars).fill(''); cursor = 0; }
                    line[cursor++] = c;
                });
                lines.push(line);
            });
            if(lines.length === 0 || (title && lines.length > 0)) lines.push(Array(chars).fill(''));

            const footerText = (className + ' ' + name).trim();
            if(footerText) {
                let line = Array(chars).fill('');
                let start = Math.max(0, chars - footerText.length - 1);
                footerText.split('').forEach((c, i) => {
                    if(start + i < chars) line[start + i] = c;
                });
                lines.push(line);
                lines.push(Array(chars).fill(''));
            }
            return lines;
        };

        const parseBody = (text, chars) => {
            const lines = [];
            const noStart = ['、','。','」','』','）','っ','ゃ','ゅ','ょ','ッ','ャ','ュ','ョ','ー',',','.','」','』',']','}','>','ぁ','ぃ','ぅ','ぇ','ぉ','ァ','ィ','ゥ','ェ','ォ','ヮ','ヵ','ヶ','・','？','！','‼','⁇','々'];
            const noEnd = ['「', '『', '（', '(', '[', '{', '<', '【', '〔', '［'];
            const compressionPairs = ['。」', '。』', '。）', '、」', '、』', '、）', '！』', '！」', '？』', '？」'];
            
            text.split('\n').forEach(p => {
                if(!p) { lines.push(Array(chars).fill('')); return; }
                let line = [];
                const pChars = p.split('');
                let i = 0;
                while(i < pChars.length) {
                    let char = pChars[i];
                    if (i < pChars.length - 1) {
                        const pair = char + pChars[i+1];
                        if (compressionPairs.includes(pair)) { char = pair; i++; }
                    }
                    if (line.length === chars - 1) {
                         if (noEnd.includes(char.charAt(0))) {
                             lines.push(line); line = []; line.push(char); i++; continue;
                         }
                    }
                    line.push(char); i++;
                    if (line.length >= chars) {
                        while (i < pChars.length) {
                            let nextStartChar = pChars[i];
                            let nextUnit = nextStartChar;
                            let step = 1;
                            if (i < pChars.length - 1) {
                                const nextPair = nextStartChar + pChars[i+1];
                                if (compressionPairs.includes(nextPair)) { nextUnit = nextPair; step = 2; }
                            }
                            if (noStart.includes(nextUnit.charAt(0))) {
                                line.push(nextUnit); i += step;
                            } else { break; }
                        }
                        lines.push(line); line = [];
                    }
                }
                if(line.length > 0) lines.push(line);
            });
            return lines;
        };

        const renderApp = () => {
            ui.charCount.textContent = ui.content.value.length;
            const chars = state.charsPerLine;
            const header = generateHeaderLines(ui.title.value, ui.class.value, ui.name.value, chars);
            const body = parseBody(ui.content.value, chars);
            const all = [...header, ...body];

            ui.grid.innerHTML = '';
            
            const renderLen = Math.max(all.length, 10);
            const cellSize = chars === 20 ? '2.8rem' : '3.6rem';
            const fontSize = chars === 20 ? '1.6rem' : '2.0rem';

            for(let i=0; i<renderLen; i++) {
                const rowData = all[i] || [];
                const lineDiv = document.createElement('div');
                lineDiv.className = 'genko-line';
                for(let j=0; j<chars; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'genko-cell';
                    cell.style.width = cellSize;
                    cell.style.height = cellSize;
                    cell.style.fontSize = fontSize;
                    cell.textContent = rowData[j] || '';
                    if(j === chars - 1 && rowData.length > chars) { 
                        const hang = document.createElement('div');
                        hang.className = 'hanging-char';
                        hang.textContent = rowData.slice(chars).join('');
                        cell.appendChild(hang);
                    }
                    lineDiv.appendChild(cell);
                }
                ui.grid.appendChild(lineDiv);
            }
            
            setTimeout(fitPaperToScreen, 50);
        };

        window.addEventListener('resize', () => {
            fitPaperToScreen();
        });

        // --- Actions ---

        window.showSettings = () => {
            Swal.fire({
                html: `
                    <div class="mb-3 fs-5 fw-bold"><ruby>用紙<rt>ようし</rt></ruby><ruby>設定<rt>せってい</rt></ruby></div>
                    <div class="text-start p-3">
                        <label class="form-label fw-bold"><ruby>文字<rt>もじ</rt></ruby>の<ruby>数<rt>かず</rt></ruby></label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="charSetting" id="char20" value="20" ${state.charsPerLine === 20 ? 'checked' : ''}>
                            <label class="form-check-label" for="char20">
                                20<ruby>文字<rt>もじ</rt></ruby> × 20<ruby>行<rt>ぎょう</rt></ruby> (400<ruby>字詰<rt>じづめ</rt></ruby>)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="charSetting" id="char15" value="15" ${state.charsPerLine === 15 ? 'checked' : ''}>
                            <label class="form-check-label" for="char15">
                                15<ruby>文字<rt>もじ</rt></ruby> × 16<ruby>行<rt>ぎょう</rt></ruby> (<ruby>低学年<rt>ていがくねん</rt></ruby><ruby>用<rt>よう</rt></ruby>)
                            </label>
                        </div>
                    </div>
                `,
                confirmButtonText: '<ruby>変更<rt>へんこう</rt></ruby>する',
                showCancelButton: true,
                cancelButtonText: 'キャンセル',
                preConfirm: () => {
                    const selected = document.querySelector('input[name="charSetting"]:checked').value;
                    return parseInt(selected);
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    state.charsPerLine = result.value;
                    renderApp();
                    autoSave();
                    Swal.fire({
                        icon: 'success',
                        html: '<div class="fs-5 fw-bold"><ruby>変更<rt>へんこう</rt></ruby>しました</div>',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        };

        ui.btns.new.addEventListener('click', () => {
            Swal.fire({
                html: '<div class="fs-4 fw-bold mb-3"><ruby>確認<rt>かくにん</rt></ruby></div>' +
                      'いま<ruby>書<rt>か</rt></ruby>いている<ruby>内容<rt>ないよう</rt></ruby>を<ruby>消<rt>け</rt></ruby>して、<br><ruby>新<rt>あたら</rt></ruby>しい<ruby>紙<rt>かみ</rt></ruby>にしますか？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<ruby>新<rt>あたら</rt></ruby>しく<ruby>書<rt>か</rt></ruby>く',
                cancelButtonText: 'キャンセル',
                confirmButtonColor: '#1a73e8'
            }).then((result) => {
                if (result.isConfirmed) {
                    state.currentDraftId = null;
                    ui.title.value = ''; ui.class.value = ''; ui.name.value = ''; ui.content.value = '';
                    renderApp();
                    clearAutoSave();
                    Swal.fire({
                        icon: 'success',
                        html: '<div class="mb-2 fw-bold fs-4"><ruby>準備<rt>じゅんび</rt></ruby>OK!</div><ruby>新<rt>あたら</rt></ruby>しい<ruby>作文<rt>さくぶん</rt></ruby>を<ruby>始<rt>はじ</rt></ruby>めましょう',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        });

        ui.btns.save.addEventListener('click', () => {
            if(!ui.content.value) {
                Swal.fire({
                    icon: 'warning',
                    title: 'エラー',
                    html: '<ruby>本文<rt>ほんぶん</rt></ruby>が<ruby>書<rt>か</rt></ruby>かれていません'
                });
                return;
            }

            setLoading(true);
            const data = {
                id: state.currentDraftId,
                title: ui.title.value,
                class: ui.class.value,
                name: ui.name.value,
                content: ui.content.value
            };

            google.script.run
                .withSuccessHandler(res => {
                    setLoading(false);
                    if(res.status === 'success') {
                        state.currentDraftId = res.id;
                        autoSave();
                        Swal.fire({
                            icon: 'success',
                            html: '<div class="fs-4 fw-bold mb-2"><ruby>保存<rt>ほぞん</rt></ruby><ruby>完了<rt>かんりょう</rt></ruby></div><ruby>作文<rt>さくぶん</rt></ruby>を<ruby>保存<rt>ほぞん</rt></ruby>しました！',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire('エラー', res.message, 'error');
                    }
                })
                .withFailureHandler(err => {
                    setLoading(false);
                    Swal.fire({
                        icon: 'error',
                        title: '<ruby>通信<rt>つうしん</rt></ruby>エラー', 
                        html: err.message
                    });
                })
                .saveOrUpdateDraft(data);
        });

        ui.btns.load.addEventListener('click', () => {
            setLoading(true);
            google.script.run
                .withSuccessHandler(list => {
                    setLoading(false);
                    state.allDrafts = list;
                    if(list.length === 0) {
                        Swal.fire({
                            icon: 'info',
                            html: '<div class="fs-5 fw-bold"><ruby>空<rt>から</rt></ruby>っぽ</div><ruby>保存<rt>ほぞん</rt></ruby>された<ruby>作文<rt>さくぶん</rt></ruby>はありません'
                        });
                        return;
                    }
                    showLoadModal();
                })
                .getDraftList();
        });

        const showLoadModal = () => {
            Swal.fire({
                html: `
                    <div class="fs-4 fw-bold mb-3"><ruby>保存<rt>ほぞん</rt></ruby>した<ruby>作文<rt>さくぶん</rt></ruby></div>
                    <div class="text-start">
                        <div class="mb-3 p-2 bg-light rounded">
                            <label class="small text-muted mb-1"><ruby>検索<rt>けんさく</rt></ruby></label>
                            <input type="text" id="search-keyword" class="form-control form-control-sm mb-2" placeholder="名前や題名でさがす...">
                            <div class="d-flex gap-2 align-items-center">
                                <input type="date" id="search-date-start" class="form-control form-control-sm">
                                <span class="small">～</span>
                                <input type="date" id="search-date-end" class="form-control form-control-sm">
                            </div>
                        </div>
                        <div id="draft-list-container" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true,
                width: '600px',
                didOpen: () => {
                    const container = document.getElementById('draft-list-container');
                    const inputKeyword = document.getElementById('search-keyword');
                    const inputStart = document.getElementById('search-date-start');
                    const inputEnd = document.getElementById('search-date-end');

                    const updateList = () => {
                        const keyword = inputKeyword.value.toLowerCase();
                        const start = inputStart.value ? new Date(inputStart.value) : null;
                        const end = inputEnd.value ? new Date(inputEnd.value) : null;
                        if(end) end.setHours(23, 59, 59, 999);

                        const filtered = state.allDrafts.filter(d => {
                            const matchKey = (d.title + d.name).toLowerCase().includes(keyword);
                            let matchDate = true;
                            if(start || end) {
                                const dDate = new Date(d.updatedAt); 
                                if(start && dDate < start) matchDate = false;
                                if(end && dDate > end) matchDate = false;
                            }
                            return matchKey && matchDate;
                        });

                        const displayList = filtered.slice(0, 20);
                        
                        if(displayList.length === 0) {
                            container.innerHTML = '<div class="text-center text-muted p-3">みつかりませんでした</div>';
                            return;
                        }

                        container.innerHTML = displayList.map(item => `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom text-start">
                                <div>
                                    <div class="fw-bold text-primary">${item.title || '<ruby>無題<rt>むだい</rt></ruby>'}</div>
                                    <div class="small text-muted">${item.name || '<ruby>名無<rt>なな</rt></ruby>し'} - ${item.updatedAt}</div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success me-1 load-item" data-id="${item.id}"><ruby>開<rt>ひら</rt></ruby>く</button>
                                    <button class="btn btn-sm btn-outline-danger del-item" data-id="${item.id}"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        `).join('');
                        
                        if(filtered.length > 20) {
                            const info = document.createElement('div');
                            info.className = 'text-center small text-muted mt-2';
                            info.innerText = `全${filtered.length}件中、新しい20件を表示しています`;
                            container.appendChild(info);
                        }
                    };

                    [inputKeyword, inputStart, inputEnd].forEach(el => el.addEventListener('input', updateList));
                    
                    updateList();

                    container.addEventListener('click', (e) => {
                        const loadBtn = e.target.closest('.load-item');
                        const delBtn = e.target.closest('.del-item');
                        if(loadBtn) loadDraft(loadBtn.dataset.id);
                        else if(delBtn) deleteDraft(delBtn.dataset.id);
                    });
                }
            });
        };

        const loadDraft = (id) => {
            Swal.close();
            setLoading(true);
            google.script.run.withSuccessHandler(res => {
                setLoading(false);
                if(res.status === 'success') {
                    const d = res.data;
                    state.currentDraftId = d.id;
                    ui.title.value = d.title;
                    ui.class.value = d.class;
                    ui.name.value = d.name;
                    ui.content.value = d.content;
                    renderApp();
                    autoSave();
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                    Toast.fire({ 
                        icon: 'success', 
                        html: '<span class="fw-bold"><ruby>読<rt>よ</rt></ruby>み<ruby>込<rt>こ</rt></ruby>みました</span>' 
                    });
                }
            }).loadDraft(id);
        };

        const deleteDraft = (id) => {
            Swal.fire({
                html: '<div class="fs-4 fw-bold mb-3"><ruby>本当<rt>ほんとう</rt></ruby>に<ruby>消<rt>け</rt></ruby>しますか？</div>' + 
                      'このそうさは、もとに もどせません。',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '<ruby>削除<rt>さくじょ</rt></ruby>する',
                cancelButtonText: 'やめる'
            }).then((result) => {
                if (result.isConfirmed) {
                    setLoading(true);
                    google.script.run.withSuccessHandler(res => {
                        setLoading(false);
                        if(res.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                html: '<div class="fs-4 fw-bold">削除完了</div>' + res.message
                            });
                            state.allDrafts = state.allDrafts.filter(d => d.id !== id);
                            
                            if(state.currentDraftId === id) {
                                state.currentDraftId = null;
                                ui.title.value = ''; ui.content.value = '';
                                renderApp();
                                clearAutoSave();
                            }
                        }
                    }).deleteDraft(id);
                }
            });
        };

        ui.btns.print.addEventListener('click', () => {
            const area = ui.printArea;
            area.innerHTML = '';
            
            const chars = state.charsPerLine;
            const linesPerPage = chars === 20 ? 20 : 16;
            const halfLines = linesPerPage / 2; 

            const header = generateHeaderLines(ui.title.value, ui.class.value, ui.name.value, chars);
            const body = parseBody(ui.content.value, chars);
            const all = [...header, ...body];
            
            const pages = Math.ceil(all.length / linesPerPage) || 1;
            const fontSize = chars === 20 ? '16pt' : '20pt';

            for(let p=0; p<pages; p++) {
                const pageLines = all.slice(p*linesPerPage, (p+1)*linesPerPage);
                const pageDiv = document.createElement('div');
                pageDiv.className = 'print-page';
                
                const gridLayout = document.createElement('div');
                gridLayout.className = 'print-layout-grid';

                const rightGrid = document.createElement('div');
                rightGrid.className = 'print-half-grid right-side';
                for(let i=0; i < halfLines; i++) {
                    const lineData = pageLines[i] || [];
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'print-line';
                    for(let j=0; j<chars; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'print-cell';
                        cell.style.fontSize = fontSize;
                        cell.textContent = lineData[j] || '';
                        if(j===chars-1 && lineData.length > chars) { 
                            const h = document.createElement('div');
                            h.className = 'hanging-chars-print';
                            h.textContent = lineData.slice(chars).join('');
                            cell.appendChild(h);
                        }
                        lineDiv.appendChild(cell);
                    }
                    rightGrid.appendChild(lineDiv);
                }

                const gyobiArea = document.createElement('div');
                gyobiArea.className = 'print-gyobi-area';
                gyobiArea.innerHTML = `
                    <div class="gyobi-content">
                        <div class="gyobi-mark"></div>
                        <div>${ui.title.value.substring(0,8)}</div>
                        <div style="font-size:0.8em; margin-top:5mm;">${p+1}</div>
                    </div>
                `;

                const leftGrid = document.createElement('div');
                leftGrid.className = 'print-half-grid left-side';
                for(let i=halfLines; i < linesPerPage; i++) {
                    const lineData = pageLines[i] || [];
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'print-line';
                    for(let j=0; j<chars; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'print-cell';
                        cell.style.fontSize = fontSize;
                        cell.textContent = lineData[j] || '';
                        if(j===chars-1 && lineData.length > chars) {
                            const h = document.createElement('div');
                            h.className = 'hanging-chars-print';
                            h.textContent = lineData.slice(chars).join('');
                            cell.appendChild(h);
                        }
                        lineDiv.appendChild(cell);
                    }
                    leftGrid.appendChild(lineDiv);
                }

                gridLayout.appendChild(leftGrid);
                gridLayout.appendChild(gyobiArea);
                gridLayout.appendChild(rightGrid);
                
                pageDiv.appendChild(gridLayout);
                area.appendChild(pageDiv);
            }

            setTimeout(() => window.print(), 500);
        });

        [ui.title, ui.class, ui.name, ui.content].forEach(el => {
            el.addEventListener('input', () => {
                renderApp();
                autoSave();
            });
        });

        tryRestore();
        renderApp();
    });
    </script>
</body>
</html>
